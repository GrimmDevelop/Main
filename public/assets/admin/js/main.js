grimmApp.config(["$routeProvider",function(e){e.when("/files",{controller:"filesController",templateUrl:"admin/partials/files"}).when("/users",{templateUrl:"admin/partials/users",controller:"userController"}).when("/letters",{templateUrl:"admin/partials/letters",controller:"letterController"}).when("/locations",{templateUrl:"admin/partials/locations",controller:"locationsController"}).when("/persons",{templateUrl:"admin/partials/persons",controller:"personsController"}).when("/import",{templateUrl:"admin/partials/import",controller:"importController"}).when("/assign",{templateUrl:"admin/partials/assign",controller:"assignController"}).when("/mailing",{templateUrl:"admin/partials/mailingList",controller:"mailingListController"}).when("/",{templateUrl:"admin/partials/dashboard",controller:"dashboardController"}).otherwise({redirectTo:"/"})}]),grimmApp.controller("assignController",["$scope","$modal","Assigner","Persons",function(e,n,t,r){function o(n){e.locationsToCheck=e.locationsToCheck.filter(function(e){return e.name!=n.name})}function s(n){e.personsToCheck=e.personsToCheck.filter(function(e){return e.name!=n.name})}e.message=null,e.closeMessage=function(){e.message=null},e.numbersToAssign=500,e.locationsToCheck=[],e.personsToCheck=[],e.resetLists=function(){e.locationsToCheck=[],e.personsToCheck=[]},e.from=function(){e.resetLists(),t.from(e.numbersToAssign).success(function(n){e.message=n,e.locationsToCheck=n.failed}).error(function(n){e.message=n})},e.to=function(){e.resetLists(),t.to(e.numbersToAssign).success(function(n){e.message=n,e.locationsToCheck=n.failed}).error(function(n){e.message=n})},e.senders=function(){e.resetLists(),t.senders(e.numbersToAssign).success(function(n){e.message=n,e.personsToCheck=n.failed}).error(function(n){e.message=n})},e.receivers=function(){e.resetLists(),t.receivers(e.numbersToAssign).success(function(n){e.message=n,e.personsToCheck=n.failed}).error(function(n){e.message=n})},e.search=function(e){var r=n.open({templateUrl:"admin/partials/searchLocation",controller:"searchLocationController",resolve:{name:function(){return e.name}}});r.result.then(function(n){t.cacheLocation(e.name,n).success(function(){o(e)})},function(){})},e.searchPerson=function(e){var r=n.open({templateUrl:"admin/partials/searchPerson",controller:"searchPersonController",resolve:{name:function(){return e.name}}});r.result.then(function(n){t.cachePerson(e.name,n).success(function(){s(e)})},function(){})},e.autoGenerate=function(e){r.autoGenerate(e.name).success(function(){s(e)})}}]),grimmApp.controller("assignLocationController",["$scope","$modal","Locations","$modalInstance","letter","mode",function(e,n,t,r,o,s){e.letter=o,e.mode=s,e.message=null,e.closeMessage=function(){e.message=null},e.selectedItem=null,e.resultList=null,e.ok=function(){r.close(e.selectedItem)},e.cancel=function(){r.dismiss("cancel")},e.search=function(n){e.selectedItem=null,e.resultList=[],t.search(n,!0).success(function(n){e.resultList=n.data}).error(function(n){e.selectedItem=null,e.message=n})},e.select=function(n){e.selectedItem=n.id,e.message={type:"success",message:"Location selected with geo id "+e.selectedItem}},e.show=function(e){n.open({templateUrl:"partials/locationPreview",controller:"locationPreviewController",resolve:{location:function(){return e}}})},e.typeSearch=function(e){return t.searchAhead(e).then(function(e){return e.data.map(function(e){return e.name})})}}]),grimmApp.controller("assignPersonController",["$scope","$modalInstance","Persons","Letters","letter","mode",function(e,n,t,r,o,s){e.letter=o,e.mode=s,e.message=null,e.showMessage=function(n){e.closeMessage(),e.message=n},e.closeMessage=function(){e.message=null},e.selectedItem=null,e.resultList=null,e.ok=function(){n.close(e.selectedItem)},e.cancel=function(){n.dismiss("cancel")},e.search=function(n){e.selectedItem=null,t.search(n).success(function(n){e.selectedItem=n[0].id,e.message={type:"success",message:"Person found with id "+e.selectedItem}}).error(function(n){e.selectedItem=null,e.message=n})},e.unassign=function(){r.unassign().success(function(){})},e.select=function(n){e.selectedItem=n},e.typeSearch=function(e){return t.searchAhead(e).then(function(e){return e.data.map(function(e){return e.name})})}}]),grimmApp.controller("dashboardController",["$scope","$http","$location","BASE_URL",function(e,n,t,r){serviceBackend=r+"/api/",e.go=function(e){t.path(e)}}]),grimmApp.controller("filesController",["$scope","$modal","FileBrowser",function(e,n,t){e.files=[],e.upload={},e.upload.flow=null,e.cd=function(n,r){t.cd(n).success(function(n){e.files=n,e.$broadcast("file-clicked",null)}),"undefined"!=typeof r&&r.preventDefault()},e.open_mkdir=function(){var r=n.open({templateUrl:"admin/partials/mkdir_modal",controller:"MkdirController",resolve:{cwd:function(){return t.cwd()}}});r.result.then(function(n){t.mkdir(t.cwd(),n).success(function(){e.refresh()})})},e.refresh=function(n){e.cd(t.cwd()),"undefined"!=typeof n&&n.preventDefault()},e.uploadComplete=function(){e.refresh(),e.upload.flow.cancel()},e.$on("browser-needs-refresh",function(){e.refresh()}),e.$on("directory-deleted",function(){e.refresh()}),e.hideComplete=function(e){return!e.isComplete()},e.fileAdded=function(e,n){n.virtualPath=t.cwd()},e.startUpload=function(){e.upload.flow.upload()},e.queryBuild=function(e){return{virtualPath:e.virtualPath}},e.preview=function(n,t){e.$broadcast("file-clicked",n),e.selected=n.path,"undefined"!=typeof ev&&t.preventDefault()},e.move=function(n,r){t.move(n.path,r.path).success(function(){e.refresh()})},e.cd("/")}]),grimmApp.controller("MkdirController",["$scope","$modalInstance","cwd",function(e,n,t){e.fields={},e.fields.dirname="",e.cwd=t,e.ok=function(){n.close(e.fields.dirname)},e.cancel=function(){n.dismiss("cancel")},e.hitEnter=function(n){!angular.equals(n.keyCode,13)||angular.equals(e.fields.dirname,null)||angular.equals(e.fields.dirname,"")||e.ok()}}]),grimmApp.controller("groupPreviewController",["$scope","$interval","$modalInstance","group",function(e,n,t,r){e.group=r,e.cancel=function(){t.dismiss("cancel")}}]),grimmApp.controller("importController",["$scope","ImportLetter","ImportLocation","ImportPerson",function(e,n,t,r){e.message={},e.closeMessage=function(){e.message=null},e.mode="index",e.selectedLetterFile=null,e.selectedLocationFile=null,e.selectedPersonFile=null,e.index=function(n){e.mode="index","undefined"!=typeof n&&n.preventDefault()},e.startLetterImport=function(t,r){"undefined"!=typeof t&&t.preventDefault(),n.start(r).success(function(n){e.message=n,e.index()}).error(function(n){e.message=n}),e.reset()},e.startLocationImport=function(n,r){"undefined"!=typeof n&&n.preventDefault(),t.start(r).success(function(n){e.message=n,e.index()}).error(function(n){e.message=n}),e.reset()},e.startPersonImport=function(n,t){"undefined"!=typeof n&&n.preventDefault(),r.start(t).success(function(n){e.message=n,e.index()}).error(function(n){e.message=n}),e.reset()},e.reset=function(){e.mode="index",e.selectedLetterFile=null,e.selectedLocationFile=null,e.selectedPersonFile=null}}]),grimmApp.controller("letterController",["$scope","$modal","Letters",function(e,n,t){e.message=null,e.closeMessage=function(){e.message=null},e.letters=[],e.itemsPerPage=25,e.currentPage=1,e.itemsPerPageOptions=[10,15,20,25,30,35,40,50,60,70,80,90,100,150],e.showLettersWithErrors={from:!1,to:!1,senders:!1,receivers:!1},e.show=function(e){n.open({templateUrl:"admin/partials/letterEdit",controller:"letterEditController",size:"lg",resolve:{id:function(){return e}}})},e.reload=function(){var n=e.itemsPerPage,r=e.currentPage,o=e.showLettersWithErrors;t.page(n,r,o).success(function(n){e.letters=n})},e.reload(),e.openPersonModal=function(e,t){n.open({templateUrl:"admin/partials/assign."+t.toLowerCase(),controller:"assignPersonController",resolve:{letter:function(){return e},mode:function(){return t.toLowerCase()}}})},e.openLocationModal=function(e,t){n.open({templateUrl:"admin/partials/assign."+t.toLowerCase(),controller:"assignLocationController",resolve:{letter:function(){return e},mode:function(){return t.toLowerCase()}}})},e.openLetterId=null,e.openLetterWithId=function(){e.show(e.openLetterId)}}]),grimmApp.controller("letterEditController",["$scope","$modal","$modalInstance","Letters","id",function(e,n,t,r,o){e.letter={},e.cancel=function(){t.dismiss("cancel")},e.load=function(n){r.get(n).success(function(n){e.letter=n,e.letter.information.map(function(e){e.state="keep"})}).error(function(){e.cancel()})},e.removeInformation=function(n){if("add"!=n.state)n.state="remove"==n.state?"keep":"remove";else{var t=e.letter.information.indexOf(n);-1!=t&&e.letter.information.splice(t,1)}},e.save=function(){r.save(e.letter).success(function(){e.load(o)})},e.addCode=function(){var t=n.open({templateUrl:"admin/partials/letterEditAddCode",controller:"letterEditAddCodeController"});t.result.then(function(n){e.letter.information.push({state:"add",code:n,data:null})},function(){})},e.load(o)}]),grimmApp.controller("letterEditAddCodeController",["$scope","$modalInstance","Search",function(e,n,t){e.code=null,e.codes=[],t.codes().success(function(n){e.codes=n}),e.ok=function(){null!=e.code&&""!=e.code&&n.close(e.code)},e.cancel=function(){n.dismiss("cancel")}}]),grimmApp.controller("locationsController",["$scope","$modal","Locations",function(e,n,t){e.locations=[],e.zoom=13,e.itemsPerPage=25,e.currentPage=1,e.itemsPerPageOptions=[10,15,20,25,30,35,40,50,60,70,80,90,100,150],e.reload=function(n,r){t.all(n,r).success(function(n){e.locations=n})},e.reload(e.itemsPerPage,e.currentPage)}]),grimmApp.controller("mailingListController",["$scope","MailingList",function(e,n){e.mailList=[],n.list().success(function(n){e.mailList=n})}]),grimmApp.controller("personEditController",["$scope","$modal","$modalInstance","Persons","id",function(e,n,t,r,o){e.person={},e.cancel=function(){t.dismiss("cancel")},e.load=function(n){r.get(n).success(function(n){e.person=n,e.person.information.map(function(e){e.state="keep"})}).error(function(){e.cancel()})},e.removeInformation=function(n){if("add"!=n.state)n.state="remove"==n.state?"keep":"remove";else{var t=e.person.information.indexOf(n);-1!=t&&e.person.information.splice(t,1)}},e.save=function(){r.save(e.person).success(function(){e.load(o)})},e.addCode=function(){var t=n.open({templateUrl:"admin/partials/personEditAddCode",controller:"personEditAddCodeController"});t.result.then(function(n){e.person.information.push({state:"add",code:n,data:null})},function(){})},e.load(o)}]),grimmApp.controller("personEditAddCodeController",["$scope","$modalInstance","Search",function(e,n,t){e.code=null,e.codes=[],t.codes().success(function(n){e.codes=n}),e.ok=function(){null!=e.code&&""!=e.code&&n.close(e.code)},e.cancel=function(){n.dismiss("cancel")}}]),grimmApp.controller("personsController",["$scope","$modal","Persons",function(e,n,t){e.persons=[],e.itemsPerPage=25,e.currentPage=1,e.itemsPerPageOptions=[10,15,20,25,30,35,40,50,60,70,80,90,100,150],e.currentOrderBy="received_letters_count",e.currentOrderByDirection="desc",e.autoGenerated=!1,e.reload=function(){var n=e.itemsPerPage,r=e.currentPage,o=e.currentOrderBy,s=e.currentOrderByDirection,i=e.autoGenerated;t.all(n,r,o,s,i).success(function(n){e.persons=n})},e.reload(),e.show=function(e){n.open({templateUrl:"admin/partials/personEdit",controller:"personEditController",size:"lg",resolve:{id:function(){return e}}})},e.orderBy=function(n){e.currentOrderBy!=n?(e.currentOrderBy=n,e.currentOrderByDirection="asc"):e.currentOrderByDirection="asc"==e.currentOrderByDirection?"desc":"asc",e.reload()}}]),grimmApp.controller("userController",["$scope","UsersService",function(e,n){e.mode="index",e.currentUser={},e.message={},e.closeMessage=function(){e.message=null},e.refresh=function(){n.all().success(function(n){e.users=n})},e.index=function(){e.mode="index",e.currentUser={}},e.edit=function(n){e.mode="edit",e.currentUser=n},e.create=function(){e.mode="create",e.currentUser={}},e.save=function(){"edit"==e.mode?n.update(e.currentUser).success(function(n){e.message=n,e.index()}).error(function(n){e.message=n}):"create"==e.mode&&n.create(e.currentUser).success(function(n){e.message=n}).error(function(n){e.message=n})},e.cancel=function(n){e.refresh(),e.index(),n.preventDefault()},e.delete=function(n){bootbox.confirm("Sure to delete "+e.currentUser.username+"?",function(n){n&&console.log("delete "+e.currentUser.username)}),n.preventDefault()},e.refresh()}]),grimmApp.directive("letterEdit",["$modal",function(e){return{restrict:"A",link:function(n,t){t.on("click",function(){e.open({templateUrl:"admin/partials/letterEdit",controller:"letterEditController",size:"lg",resolve:{id:function(){return n.letterId}}})})},scope:{letterId:"=letterEdit"}}}]),grimmApp.directive("personEdit",["$modal",function(e){return{restrict:"A",link:function(n,t){t.on("click",function(){e.open({templateUrl:"admin/partials/personEdit",controller:"personEditController",size:"lg",resolve:{id:function(){return n.personId}}})})},scope:{personId:"=personEdit"}}}]),grimmApp.service("Assigner",["$http","BASE_URL",function(e,n){var t=n+"/admin/assign/";this.from=function(n){return e.post(t+"from/"+n)},this.to=function(n){return e.post(t+"to/"+n)},this.senders=function(n){return e.post(t+"senders/"+n)},this.receivers=function(n){return e.post(t+"receivers/"+n)},this.cacheLocation=function(n,r){return e.post(t+"cache/location",{name:n,geo_id:r})},this.cachePerson=function(n,r){return e.post(t+"cache/person",{name:n,person_id:r})}}]),grimmApp.service("FileBrowser",["$http","BASE_URL",function(e,n){var t=n+"/admin/files",r=[""];this.cd=function(e){var n=this.makeAbsolute(e);return i(o(n)).success(function(){r=n})},this.makeAbsolute=function(e){if("/"==e)return[""];if("/"==e[0])return e.split("/");for(var n=e.split("/"),t=r.slice(),o=0;o<n.length;o++)".."==n[o]?t.length>1&&t.pop():"."!=n[o]&&t.push(n[o]);return t},this.move=function(n,r){return e.get(t+"/move",{params:{src:n,dest:r}})},this.mkdir=function(n,r){return e.get(t+"/mkdir",{params:{basepath:n,name:r}})},this.deleteFile=function(n){return e.get(t+"/delete",{params:{path:n}})},this.deleteFolder=function(n){return e.get(t+"/deleteFolder",{params:{path:n}})},this.rename=function(n,r){return console.log(s(n)+"/"+r),e.get(t+"/rename",{params:{src:n,dest:r}})},this.cwd=function(e){return e="undefined"==typeof e?!1:e,e?r:o(r)};var o=function(e){var n=e.join("/");return""===n?"/":n},s=function(e){return e?e.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,""):"/"};this.dirname=s;var i=function(n){return e.get(t+"/list",{params:{path:n}})}}]),grimmApp.service("ImportLetter",["$http","BASE_URL",function(e,n){var t=n+"/admin/import/letters";this.start=function(n){return e.post(t,{data:n})}}]),grimmApp.service("ImportLocation",["$http","BASE_URL",function(e,n){var t=n+"/admin/import/locations";this.start=function(n){return e.post(t,{data:n})}}]),grimmApp.service("ImportPerson",["$http","BASE_URL",function(e,n){var t=n+"/admin/import/persons";this.start=function(n){return e.post(t,{data:n})}}]),grimmApp.service("MailingList",["$http","BASE_URL",function(e,n){var t=n+"/admin/mailing/";this.list=function(){return e.get(t+"list")}}]),grimmApp.service("UsersService",["$http","BASE_URL",function(e,n){var t=n+"/api/";this.all=function(){return e.get(t+"users")},this.getGroup=function(n){return e.get(t+"groups/"+n)},this.create=function(n){return e.post(t+"users",n)},this.update=function(n){return e.put(t+"users/"+n.id,n)},this.delete=function(n){return e.delete(t+"users/"+n.id)}}]);